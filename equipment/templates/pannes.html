{% block content %}
<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion des Pannes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    /* === Base Styling === */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #c0d8f0, #c3d6f3);
      padding: 30px;
      color: #1f2937;
      animation: fadeIn 0.8s ease-in;
    }

    /* Animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* Title */
    h2.main-title {
      text-align: center;
      font-size: 2.2rem;
      font-weight: 700;
      color: #1e3a8a;
      margin-bottom: 30px;
    }

    /* Card / Content */
    .content-wrapper {
      max-width: 960px;
      margin: auto;
      background: #ffffffdd;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    /* Navigation */
    .nav-link a {
      text-decoration: none;
      font-weight: 600;
      color: #2563eb;
      transition: color 0.3s ease;
    }

    .nav-link a:hover {
      color: #1d4ed8;
    }

    /* Inputs & Selects */
    .custom-input,
    .custom-select {
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      padding: 12px;
      font-size: 1rem;
      background-color: #fff;
      transition: all 0.3s ease;
    }

    .custom-input:focus,
    .custom-select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      outline: none;
    }

    /* Filter Bar */
    .filter-bar {
      background-color: #f1f5f9;
      padding: 20px;
      border-radius: 14px;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.03);
      margin-bottom: 30px;
    }

    /* Add Button */
    .fixed-add-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #10b981;
      color: white;
      font-size: 1.8rem;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 999;
    }

    .fixed-add-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 24px rgba(16, 185, 129, 0.6);
    }

    .bounce {
      animation: bounce 2s infinite;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-5px);
      }
    }

    .card-modern {
      background-color: #ffffff;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      padding: 30px;
      margin: 30px auto;
      max-width: 1150px;
      animation: fadeInUp 0.6s ease-in-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(25px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-title {
      text-align: center;
      font-size: 26px;
      color: #2c3e50;
      margin-bottom: 30px;
      font-weight: 600;
    }

    .table-container {
      overflow-x: auto;
    }

    .modern-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }

    .modern-table th,
    .modern-table td {
      padding: 14px 18px;
      text-align: center;
      border-bottom: 1px solid #eaeaea;
    }

    .modern-table thead {
      background-color: #2196f3;
      color: white;
    }

    .panne-img {
      width: 70px;
      height: auto;
      border-radius: 6px;
      transition: transform 0.3s ease;
    }

    .panne-img:hover {
      transform: scale(1.1);
    }

    .no-img {
      color: #999;
      font-style: italic;
    }

    .urgence {
      font-weight: bold;
      padding: 6px 10px;
      border-radius: 6px;
    }

    .urgence-faible {
      color: #27ae60;
    }

    .urgence-moyen {
      color: #e67e22;
    }

    .urgence-√©lev√© {
      color: #c0392b;
    }

    .badge-status {
      padding: 5px 10px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 13px;
      display: inline-block;
    }

    .resolu {
      background-color: #c8e6c9;
      color: #2e7d32;
    }

    .non-resolu {
      background-color: #ffcdd2;
      color: #c62828;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .btn-action {
      border: none;
      background: none;
      font-size: 16px;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .btn-action:hover {
      transform: scale(1.1);
    }

    .btn-action.info {
      color: #2980b9;
    }

    .btn-action.edit {
      color: #f39c12;
    }

    .btn-action.delete {
      color: #e74c3c;
    }

    .no-data {
      color: #888;
      font-style: italic;
      padding: 20px;
    }

    .custom-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid #2196f3;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  .alert {
    padding: 1em;
    margin: 1em 0;
    border-radius: 6px;
  }
  .alert-success { background: #d4edda; color: #155724; }
  .alert-danger { background: #f8d7da; color: #721c24; }
  .alert-warning { background: #fff3cd; color: #856404; }
  .alert-info { background: #d1ecf1; color: #0c5460; }


    /* Button Styles */
    .btn-animated {
      background: linear-gradient(45deg, #3b82f6, #06b6d4);
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 30px;
      padding: 10px 25px;
      transition: 0.3s ease;
    }

    .btn-animated:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    /* Spinner */
    .spinner-border {
      display: none;
      margin: auto;
    }

    .main-title {
      font-size: 24px;
      font-weight: 700;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    body.custom-container {
      font-family: 'Inter', sans-serif;
      background-color: #f4f6f9;
      padding: 30px;
      margin: 0;
    }

    .filter-card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      max-width: 1000px;
      margin: auto;
    }

    .btn-home {
      background-color: #2196f3;
      color: white;
      padding: 10px 18px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: 0.3s ease;
    }

    .btn-home:hover {
      background-color: #1976d2;
      transform: scale(1.02);
    }

    .main-title {
      text-align: center;
      margin-top: 20px;
      font-size: 26px;
      color: #333;
    }

    .main-title i {
      color: #2196f3;
      margin-right: 10px;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 25px;
    }

    .filter-item {
      position: relative;
      flex: 1 1 250px;
      min-width: 220px;
    }

    .icon-left {
      position: absolute;
      top: 50%;
      left: 12px;
      transform: translateY(-50%);
      color: #2196f3;
    }

    .filter-input,
    .filter-select {
      width: 100%;
      padding: 10px 10px 10px 36px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      transition: 0.3s ease;
    }

    .filter-input:focus,
    .filter-select:focus {
      border-color: #2196f3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      outline: none;
    }

    /* Bouton flottant anim√© */
    .floating-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(145deg, #42a5f5, #7e57c2);
      color: white;
      font-size: 28px;
      border: none;
      border-radius: 50%;
      padding: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      animation: bounce 1.5s infinite;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .floating-btn:hover {
      transform: scale(1.1);
    }

    /* Animation du bouton */
    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .form-container {
      background: #ffffff;
      max-width: 600px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-title {
      text-align: center;
      font-size: 24px;
      color: #333;
      margin-bottom: 25px;
    }

    .form-group,
    .form-check {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background-color: #fafafa;
      transition: border 0.3s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: #42a5f5;
      outline: none;
    }

    .btn-submit {
      background: linear-gradient(to right, #42a5f5, #7e57c2);
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn-submit:hover {
      background: linear-gradient(to right, #1e88e5, #a8d3fa);
    }

    .form-submit {
      text-align: center;
    }

    label i,
    .form-title i,
    .btn-submit i {
      margin-right: 8px;
      color: #3b66f3;
    }
  </style>
</head>

<body class="custom-container">
  <div class="filter-card">

    <!-- Bouton accueil -->
    <div class="text-start mb-3">
      <a href="{% url 'dashboard' %}" class="btn-home">
        <i class="fa-solid fa-house"></i> Accueil
      </a>
    </div>

    <!-- Titre -->
    <h2 class="main-title">
      <i class="fas fa-tools"></i> Gestion des Pannes
    </h2>

    <!-- Barre de filtres -->
    <div class="filter-bar">
      <div class="filter-item">
        <i class="fas fa-search icon-left"></i>
        <input type="text" id="filtre-nom" class="filter-input" placeholder="Filtrer par √©quipement">
      </div>
      <div class="filter-item">
        <i class="fas fa-calendar-alt icon-left"></i>
        <input type="date" id="filtre-date" class="filter-input">
      </div>
      <div class="filter-item">
        <i class="fas fa-exclamation-circle icon-left"></i>
        <select id="filtre-urgence" class="filter-select">
          <option value="">Tous les niveaux</option>
          <option value="faible">Faible</option>
          <option value="moyen">Moyen</option>
          <option value="√©lev√©">√âlev√©</option>
        </select>
      </div>
    </div>
  </div>
  
<button id="toggle-form-btn" class="floating-btn">
  <i class="fas fa-plus"></i>
</button>

<!-- Conteneur du formulaire -->
<div id="form-container" class="form-container" style="display: none;">
  <h2 class="form-title">
    <i class="fas fa-tools"></i> D√©clarer une nouvelle panne
  </h2>
  <form id="panne-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="form-group">
      <label for="{{ form.equipment.id_for_label }}">
        <i class="fas fa-wrench"></i> √âquipement
      </label>
      {{ form.equipment }}
    </div>

    <div class="form-group">
      <label for="{{ form.description.id_for_label }}">
        <i class="fas fa-file-alt"></i> Description
      </label>
      {{ form.description }}
    </div>

    <div class="form-group">
      <label for="{{ form.image.id_for_label }}">
        <i class="fas fa-camera"></i> Image (facultatif)
      </label>
      {{ form.image }}
    </div>

    <div class="form-group">
      <label for="{{ form.niveau_urgence.id_for_label }}">
        <i class="fas fa-exclamation-triangle"></i> Niveau d'urgence
      </label>
      {{ form.niveau_urgence }}
    </div>

    <div class="form-check">
      {{ form.est_resolue }}
      <label for="{{ form.est_resolue.id_for_label }}">
        <i class="fas fa-check-circle"></i> R√©solue
      </label>
    </div>

    <div class="form-submit">
      <button type="submit" class="btn-submit">
        <i class="fas fa-paper-plane"></i> Soumettre la panne
      </button>
    </div>
  </form>
</div>

<!-- Zone d'affichage de messages -->
<div id="message-zone"></div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <!-- Liste des pannes signal√©es -->
  <div class="card-modern">
    <h3 class="section-title">Liste des Pannes Signal√©es</h3>

    <div class="custom-spinner" id="spinner" style="display:none;"></div>

    <div class="table-container">
      <table class="modern-table">
        <thead>
          <tr>
            <th>√âquipement</th>
            <th>Description</th>
            <th>Date</th>
            <th>Image</th>
            <th>Signal√©e par</th>
            <th>Urgence</th>
            <th>R√©solue</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for panne in pannes %}
          <tr>
            <td>{{ panne.equipment.name }}</td>
            <td>{{ panne.description }}</td>
            <td>{{ panne.date_signalement|date:"d-m-Y" }}</td>
            <td>
              {% if panne.image %}
              <img src="{{ panne.image.url }}" alt="Image panne" class="panne-img">
              {% else %}
              <span class="no-img">Aucune</span>
              {% endif %}
            </td>
            <td>{{ panne.signalee_par.email }}</td>
            <td><span class="urgence urgence-{{ panne.niveau_urgence }}">{{ panne.get_niveau_urgence_display }}</span>
            </td>
            <td>
              <span class="badge-status {{ panne.est_resolue|yesno:'resolu,non-resolu' }}">
                {{ panne.est_resolue|yesno:"Oui,Non" }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-action info" onclick="afficherDetails({{ panne.id }})" title="Voir d√©tails"><i
                    class="fas fa-eye"></i></button>
                <button class="btn-action edit" onclick="ouvrirFormulaireModification({{ panne.id }})"
                  title="Modifier"><i class="fas fa-pen"></i></button>
                <button class="btn-action delete" onclick="confirmerSuppression({{ panne.id }})" title="Supprimer"><i
                    class="fas fa-trash-alt"></i></button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="no-data">Aucune panne signal√©e pour le moment.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>


  <div id="modals-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // =========== 1. getCookie pour CSRF ===========
  function getCookie(name) {
    let cookieValue = null;
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
    return cookieValue;
  }

  // =========== 2. showMessage avec SweetAlert ===========
  function showMessage(message, type = 'success') {
    Swal.fire({
      icon: type,
      title: type === 'success' ? 'Succ√®s' : 'Erreur',
      html: message,
      timer: 3000,
      showConfirmButton: false
    });
  }

  // =========== 3. Submit du formulaire avec fetch ===========
  document.getElementById('panne-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    fetch('/api/pannes/create/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: formData
    })
    .then(async response => {
      const contentType = response.headers.get("content-type");
      let data = {};
      if (contentType && contentType.includes("application/json")) {
        data = await response.json();
      }

      if (response.status === 201) {
        showMessage("‚úÖ Panne ajout√©e avec succ√®s !");
        form.reset();
        document.getElementById('form-container').style.display = 'none';
        document.getElementById('toggle-form-btn').innerHTML = '<i class="fas fa-plus"></i>';
        setTimeout(() => location.reload(), 1000);
      } else if (response.status === 400 && data.errors) {
        let messages = Object.entries(data.errors).map(([field, errors]) =>
          `<strong>${field}</strong>: ${errors.join(', ')}`).join('<br>');
        showMessage(`‚ùå Erreurs de validation :<br>${messages}`, 'error');
      } else {
        showMessage("‚ùå Une erreur inattendue est survenue.", 'error');
      }
    })
    .catch(error => {
      console.error(error);
      showMessage("‚ùå Erreur r√©seau ou serveur.", 'error');
    });
  });

  // =========== 4. Toggle du formulaire ===========
  const toggleBtn = document.getElementById('toggle-form-btn');
  const formContainer = document.getElementById('form-container');

  toggleBtn.addEventListener('click', function () {
    if (formContainer.style.display === 'none' || formContainer.style.display === '') {
      formContainer.style.display = 'block';
      toggleBtn.innerHTML = '<i class="fas fa-minus"></i>';
    } else {
      formContainer.style.display = 'none';
      toggleBtn.innerHTML = '<i class="fas fa-plus"></i>';
    }
  });
</script>

  <script>
    
    function filtrerTableau() {
      const nom = document.getElementById('filtre-nom').value.toLowerCase();
      const date = document.getElementById('filtre-date').value;
      const urgence = document.getElementById('filtre-urgence').value;

      const lignes = document.querySelectorAll('table tbody tr');

      lignes.forEach(row => {
        const nomEquip = row.children[0]?.textContent.toLowerCase();
        const datePanne = row.children[2]?.textContent.trim().slice(0, 10);
        const urgencePanne = row.children[5]?.textContent.trim().toLowerCase();

        const matchNom = nom === "" || nomEquip.includes(nom);
        const matchDate = date === "" || datePanne === date;
        const matchUrgence = urgence === "" || urgencePanne === urgence;

        if (matchNom && matchDate && matchUrgence) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }

    // Ajout des √©couteurs pour les filtres
    document.getElementById('filtre-nom').addEventListener('input', filtrerTableau);
    document.getElementById('filtre-date').addEventListener('change', filtrerTableau);
    document.getElementById('filtre-urgence').addEventListener('change', filtrerTableau);

  </script>
  <script>
    function afficherDetails(id) {
      document.getElementById('spinner').style.display = 'inline-block';
      fetch(`/api/pannes/${id}/`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('spinner').style.display = 'none';
          Swal.fire({
            title: 'üõ†Ô∏è D√©tails de la panne',
            html: `
                    <p><strong>√âquipement:</strong> ${data.equipment_name}</p>
                    <p><strong>Description:</strong> ${data.description}</p>
                    <p><strong>Urgence:</strong> ${data.niveau_urgence}</p>
                    <p><strong>R√©solue:</strong> ${data.est_resolue ? 'Oui' : 'Non'}</p>
                    ${data.image ? `<img src="${data.image}" class="img-fluid" />` : 'Aucune image'}
                `,
            confirmButtonText: 'Fermer'
          });
        });
    }
function ouvrirFormulaireModification(id) {
  fetch(`/api/pannes/${id}/`)
    .then(res => res.json())
    .then(data => {
      Swal.fire({
        title: '‚úèÔ∏è Modifier la panne',
        html: `
          <textarea id="edit-description" class="form-control mb-2">${data.description}</textarea>
          <select id="edit-urgence" class="form-select mb-2">
            <option value="faible" ${data.niveau_urgence === 'faible' ? 'selected' : ''}>Faible</option>
            <option value="moyen" ${data.niveau_urgence === 'moyen' ? 'selected' : ''}>Moyen</option>
            <option value="√©lev√©" ${data.niveau_urgence === '√©lev√©' ? 'selected' : ''}>√âlev√©</option>
          </select>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="edit-resolue" ${data.est_resolue ? 'checked' : ''}>
            <label class="form-check-label" for="edit-resolue">R√©solue</label>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'üíæ Enregistrer',
        cancelButtonText: 'Annuler',
        preConfirm: () => {
          return {
            description: document.getElementById('edit-description').value.trim(),
            niveau_urgence: document.getElementById('edit-urgence').value,
            est_resolue: document.getElementById('edit-resolue').checked === true
          };
        }
      }).then(result => {
        if (result.isConfirmed) {
          fetch(`/api/pannes/${id}/update/`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
              description: result.value.description,
              niveau_urgence: result.value.niveau_urgence,
              est_resolue: result.value.est_resolue ? true : false  // ‚ú® garantit le bool√©en
            })
          })
          .then(response => {
            if (response.ok) {
              Swal.fire('‚úÖ Modifi√© !', '', 'success').then(() => location.reload());
            } else {
              Swal.fire('‚ùå √âchec de la modification', '', 'error');
            }
          })
          .catch(error => {
            console.error(error);
            Swal.fire('‚ùå Erreur de r√©seau ou serveur', '', 'error');
          });
        }
      });
    });
}

    function confirmerSuppression(id) {
      Swal.fire({
        title: '‚ùå Supprimer cette panne ?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
      }).then(result => {
        if (result.isConfirmed) {
          fetch(`/api/pannes/${id}/delete/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
          }).then(res => {
            if (res.ok) {
              Swal.fire('üóëÔ∏è Supprim√©e !', '', 'success').then(() => location.reload());
            } else {
              Swal.fire('‚ùå Erreur lors de la suppression', '', 'error');
            }
          });
        }
      });
    }
  
  </script>
</body>
{% endblock %}